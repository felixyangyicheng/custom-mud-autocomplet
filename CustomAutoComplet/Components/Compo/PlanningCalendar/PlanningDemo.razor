@page "/planningDemo"
@using MudBlazor
@inject IJSRuntime JS

<MudStack Direction="Row" AlignItems="AlignItems.Center" Spacing="2">
    <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" OnClick="PrevPeriod" />
    <MudText Typo="Typo.h6">@Title</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="GoToToday">
        Aujourd'hui
    </MudButton>
    <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" OnClick="NextPeriod" />
</MudStack>

<MudToggleGroup T="CalendarView" Value="@CurrentView" ValueChanged="OnViewChanged">
    <MudToggleItem Value="CalendarView.Week">Semaine</MudToggleItem>
    <MudToggleItem Value="CalendarView.Month">Mois</MudToggleItem>
    <MudToggleItem Value="CalendarView.Year">Année</MudToggleItem>
</MudToggleGroup>

<PlanningGrid View="CurrentView"
              Rows="Rows"
              Dates="Dates"
              Events="Events" @ref="PlanningGridRef" />
@code {
    CalendarView CurrentView = CalendarView.Week;
    DateTime CurrentStart = DateTime.Today;

    List<PlanningRow> Rows = new();
    List<DateTime> Dates = new();
    List<PlanningEvent> Events = new();

    Dictionary<string, List<PlanningEvent>> EventCache = new();

    protected override async Task OnInitializedAsync()
    {
        Rows = await LoadRows();
        await PreloadPeriod(CurrentStart, CurrentView);
        await LoadCurrentView();
    }

    // ===== 左右切换 =====
    async Task PrevPeriod()
    {
        ShiftPeriod(-1);
        await LoadCurrentView();
    }
    private PlanningGrid PlanningGridRef;

    async Task GoToToday()
    {
        CurrentStart = DateTime.Today;
        Dates = GenerateDates(CurrentStart, CurrentView);
        Events = GetCachedEvents(CurrentStart, CurrentView);

        await PlanningGridRef.ScrollToTodayAsync();
    }
    async Task NextPeriod()
    {
        ShiftPeriod(1);
        await LoadCurrentView();
    }

    void ShiftPeriod(int direction)
    {
        CurrentStart = CurrentView switch
        {
            CalendarView.Week => CurrentStart.AddDays(7 * direction),
            CalendarView.Month => CurrentStart.AddMonths(direction),
            CalendarView.Year => CurrentStart.AddYears(direction),
            _ => CurrentStart
        };
    }

    async void OnViewChanged(CalendarView view)
    {
        CurrentView = view;
        await PreloadPeriod(CurrentStart, CurrentView);
        await LoadCurrentView();
    }

    // ===== 核心：加载当前 + 缓存 =====
    async Task LoadCurrentView()
    {
        Dates = GenerateDates(CurrentStart, CurrentView);
        Events = GetCachedEvents(CurrentStart, CurrentView);
        StateHasChanged();

        // 异步预加载 n-1 和 n+1
        _ = PreloadPeriod(CurrentStart.AddPeriod(-1, CurrentView), CurrentView);
        _ = PreloadPeriod(CurrentStart.AddPeriod(1, CurrentView), CurrentView);
    }

    List<DateTime> GenerateDates(DateTime start, CalendarView view) => view switch
    {
        CalendarView.Week => Enumerable.Range(0, 7)
            .Select(i => StartOfWeek(start).AddDays(i)).ToList(),

        CalendarView.Month => Enumerable.Range(1, DateTime.DaysInMonth(start.Year, start.Month))
            .Select(d => new DateTime(start.Year, start.Month, d)).ToList(),

        CalendarView.Year => Enumerable.Range(1, 12)
            .Select(m => new DateTime(start.Year, m, 1)).ToList(),

        _ => new()
    };

    string Title => CurrentView switch
    {
        CalendarView.Week => $"{StartOfWeek(CurrentStart):dd/MM} - {StartOfWeek(CurrentStart).AddDays(6):dd/MM}",
        CalendarView.Month => CurrentStart.ToString("yyyy MMM"),
        CalendarView.Year => CurrentStart.Year.ToString(),
        _ => ""
    };

    static DateTime StartOfWeek(DateTime date) => date.AddDays(-(int)date.DayOfWeek + 1);

    // ===== 事件缓存 =====
    List<PlanningEvent> GetCachedEvents(DateTime start, CalendarView view)
    {
        var key = CacheKey(start, view);
        if (EventCache.TryGetValue(key, out var cached))
            return cached;
        return new List<PlanningEvent>();
    }

    async Task PreloadPeriod(DateTime start, CalendarView view)
    {
        var key = CacheKey(start, view);
        if (EventCache.ContainsKey(key)) return;

        // 模拟加载事件（你可以替换成 API / EF Core）
        var events = await LoadEventsForPeriod(start, view);
        EventCache[key] = events;
    }

    string CacheKey(DateTime start, CalendarView view)
        => $"{start:yyyy-MM-dd}|{view}";



    Task<List<PlanningRow>> LoadRows()
    {
        var rows = new List<PlanningRow>
    {
        // 人员
        new PlanningRow { Id = 1, Name = "张三", Type = RowType.Person },
        new PlanningRow { Id = 2, Name = "李四", Type = RowType.Person },
        new PlanningRow { Id = 3, Name = "王五", Type = RowType.Person },

        // 资源
        new PlanningRow { Id = 101, Name = "设备A", Type = RowType.Resource },
        new PlanningRow { Id = 102, Name = "设备B", Type = RowType.Resource },
        new PlanningRow { Id = 103, Name = "会议室1", Type = RowType.Resource }
    };

        return Task.FromResult(rows);
    }
    // ===== 模拟加载事件 =====
    Task<List<PlanningEvent>> LoadEventsForPeriod(DateTime start, CalendarView view)
    {
        var rnd = new Random(start.Day + start.Month + start.Year);
        var dates = GenerateDates(start, view);

        var events = new List<PlanningEvent>();

        // 对每个 Row（人员或资源）生成随机事件
        foreach (var row in Rows)
        {
            foreach (var day in dates)
            {
                // 每天给每个 Row 生成 0~2 个事件
                int eventCount = rnd.Next(0, 3);
                for (int i = 0; i < eventCount; i++)
                {
                    // 随机开始时间 9~15
                    int startHour = rnd.Next(9, 15);
                    int duration = rnd.Next(1, 4); // 持续 1~3 小时
                    int endHour = Math.Min(startHour + duration, 17);

                    events.Add(new PlanningEvent
                    {
                        Id = rnd.Next(),  // 随机唯一 Id
                        Date = day,
                        PersonId = row.Type == RowType.Person ? row.Id : 0,
                        ResourceId = row.Type == RowType.Resource ? row.Id : 0,
                        Start = new TimeSpan(startHour, 0, 0),
                        End = new TimeSpan(endHour, 0, 0)
                    });
                }
            }
        }

        return Task.FromResult(events);
    }
}

